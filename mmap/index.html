<!DOCTYPE html>
<html>
<head>
<title>Marauder's Map</title>
<link rel="stylesheet" href="mmap_style.css"/>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
<script>
var map;
var login = 'BobPicky';
var myLat = 42.4084971;
var myLng = -71.1162187; //Default is halligan hall
var myOptions = {
	zoom: 13, // The larger the zoom number, the bigger the zoom
	center: new google.maps.LatLng(myLat, myLng),
	mapTypeId: google.maps.MapTypeId.ROADMAP
};
function init() {
	// Set up map
	map = new google.maps.Map(document.getElementById("map"), myOptions);
	useMyLoc();
}
function useMyLoc () {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(position) {
			myLat = position.coords.latitude;
			myLng = position.coords.longitude;
			;
			myPos = new google.maps.LatLng(myLat, myLng)
			map.panTo(myPos);
			marker = new google.maps.Marker({
				map: map,
				position: myPos,
				title: login
			})
			requestLocs();
		});
	}
}
function requestLocs() {
	request = new XMLHttpRequest();
	request.open("POST", "https://secret-about-box.herokuapp.com/sendLocation",true);
	request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	request.onreadystatechange = function () {
		if (request.readyState = 4 && request.status == 200) {
			data = JSON.parse(this.responseText);
			drawOthers(data);
		}
	}
	request.send("login=" + login + "&lat=" + myLat + "&lng=" + myLng);
}
Number.prototype.toRadians = function() {
   return this * Math.PI / 180;
}
function drawOthers(userLocs) {
	if (typeof userLocs["error"] === "undefined") {
		userLocs.forEach(function (val, idx, arr) {
			lat = val["lat"];
			lng = val["lng"];
			dLat = myLat - lat;
			dLat = dLat.toRadians();
			dLng = myLng - lng;
			dLng = dLng.toRadians();
			a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                Math.cos(lat.toRad()) * Math.cos(mylat.toRad()) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
			c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			distance = 3963.1676 * c;
			marker = new google.maps.Marker({
				map: map,
				position: new google.maps.LatLng(lat, lng),
				title: val["login"] + ": " + distance + " miles away"
			});
		});
	}
}
</script>
</head>
<body onload="init()">
	<div id="map"></div>
</body>
</html>
